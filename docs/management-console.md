# 管理控制台操作手册

管理控制台位于 `http://<host>:<openai_port>/admin`，所有功能均依赖单一管理密钥（或其哈希）。本文档介绍主要页面与常见操作流程。

> 安全提示：请仅在可信网络内开放管理端，并在生产环境部署反向代理或 VPN。可通过 `allowed_admin_networks` 或外部 ACL 限制访问来源。

## 1. 登录与会话

1. 首次访问时输入 `management_key`。若同时配置了 `management_key_hash`，两者需匹配。
2. 登录成功后服务端会签发 `mgmt_session` Cookie；若设置了 `SESSION_SECRET`，则使用 HMAC 签名 Token，可安全地在多实例间共享。
3. 退出登录可使用“设置 → 退出”或调用 `POST /routes/api/management/logout`。

所有 API 也支持 `Authorization: Bearer <management_key>`，方便脚本与自动化任务。

## 2. 凭证管理

界面入口：“凭证”页。

- **新增凭证**：粘贴 OAuth JSON 或通过 ZIP 批量上传；保存后即时生效。
- **启用/禁用/删除**：操作按钮位于每个凭证卡片或表格行。
- **恢复能力**：
  - 单个恢复：`恢复` 按钮对应 `POST /credentials/:id/recover`；
  - 批量恢复：右上角“批量操作”→“恢复全部”或在工具栏选择多个条目后执行；
  - 接口均会返回恢复数量，并在 UI 中做提示。
- **测活**：支持 Flash 模型的快速测活（默认 10 秒超时），结果会同步到“探活历史”。
- **批量工具**：在右下角开启批量模式，可对多条凭证执行启用、禁用、删除、恢复、快速测活等操作；支持并行限制与进度提示。

## 3. 模型注册中心

界面入口：“模型”页。

- 管理 `/v1/models` 对外暴露的模型列表，支持按组/标签分类。
- 为模型配置特性：假流式、抗截断、搜索能力、图像输入、思考等级等，将在请求翻译与响应阶段自动套用。
- “上游发现”可同步 Gemini CLI 最新模型目录，再按需勾选启用；支持导入/导出 JSON。

## 4. 路由装配台

界面入口：“装配台”页。

- **总览面板**：展示当前路由计划、已暴露模型、各端点粘性与冷却状态。
- **计划管理**：
  - 保存当前配置为计划并命名；
  - `Dry Run` 支持对比计划与现状（增删模型、凭证差异）；
  - 应用/回滚计划会记录事务指标，可在 `monitoring.md` 中监控。
- **路由状态持久化**：可手动持久化粘性映射与冷却队列，并在异常时恢复。

## 5. 配置与特性开关

界面入口：“配置”页。

- 所有字段均与 `config.yaml` 对应，保存后即时写入存储并推送给运行时组件。
- 高风险项（例如自动探活）会在保存前提示确认。
- 支持 JSON/原始值编辑，也可通过 API（`PUT /routes/api/management/config`）实现自动化。

## 6. 日志与监控

- “日志”页提供 WebSocket 实时日志流，可按请求 ID 过滤。
- “统计”页展示请求量、Token 用量等聚合信息。
- “指标”页与 `monitoring.md` 对应的 Prometheus 指标一致，适合快速巡检。

## 7. 故障处理建议

| 问题 | 操作 |
| --- | --- |
| 凭证被自动封禁 | 使用“恢复”按钮或批量恢复后观察 `gcli2api_auto_probe_*` 指标；若多次失败，检查 refresh_token 是否过期。 |
| 模型未在 `/v1/models` 暴露 | 在“模型注册中心”确保已勾选目标模型，或导入默认模板。 |
| 路由异常 | 使用装配台的 `Dry Run` 查看差异；如需紧急回滚，可应用上一版本计划。 |
| 指标异常 | 打开“指标”页核对最新数据，并与 `monitoring.md` 中的指标释义对照。 |

---

更多监控细节见 [`monitoring.md`](monitoring.md)，部署与访问控制建议见 [`deployment.md`](deployment.md)。
